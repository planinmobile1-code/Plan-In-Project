<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>PM Gantt Dashboard with Overlap Highlight</title>
<style>
body {
 font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
 padding: 40px 20px;
 background: #eef2f7;
 color: #333;
}
h1 {
 text-align: center;
 margin-bottom: 40px;
 font-size: 2em;
 color: #222;
}
h2 {
 margin-top: 30px;
 margin-bottom: 10px;
 color: #1976d2;
 border-bottom: 2px solid #1976d2;
 padding-bottom: 4px;
}
h3 {
 margin-top: 15px;
 margin-bottom: 8px;
 color: #f57c00;
}
.project-info {
 background: white;
 padding: 10px 15px;
 border-radius: 8px;
 box-shadow: 0 4px 12px rgba(0,0,0,0.1);
 margin-bottom: 6px;
}
.project-info h4 {
 margin: 0 0 6px 0;
 font-size: 1em;
 color: #333;
}
.project-info p {
 margin: 2px 0;
 color: #555;
 font-size: 0.9em;
}
.countdown {
 font-size: 16px;
 font-weight: bold;
 color: #d32f2f;
 margin-top: 4px;
}
/* ÁîòÁâπÂúñ */
.gantt-container {
 position: relative;
 margin-bottom: 6px;
 height: 25px;
}
.gantt-segment {
 position: absolute;
 height: 25px;
 border-radius: 4px;
 opacity: 0.85;
 cursor: pointer;
}
.month-axis {
 display: flex;
 justify-content: space-between;
 font-size: 0.75em;
 color: #555;
 margin-bottom: 20px;
 margin-top: 4px;
}
.month-axis div {
 flex: 1;
 text-align: center;
}
.tooltip {
 position: absolute;
 background: rgba(0,0,0,0.85);
 color: white;
 padding: 6px 10px;
 border-radius: 4px;
 font-size: 0.85em;
 pointer-events: none;
 white-space: nowrap;
 z-index: 1000;
 display: none;
}
</style>
</head>
<body>
<h1>üìÖ PM Gantt Dashboard with Overlap Highlight</h1>
<div id="container"></div>
<div id="tooltip" class="tooltip"></div>
<script>
const jsonURL = "https://docs.google.com/spreadsheets/d/1_jNi6ukRJRNwNrzikG-gIZnPSjGHPpDs_ckDSy9pBNA/gviz/tq?tqx=out:json&gid=0";
const teamBaseColors = {PD1:"#4caf50", PD2:"#f57c00", PD3:"#1976d2"};
const overlapColor = "#d32f2f";
async function loadProjects() {
 try {
   const res = await fetch(jsonURL);
   const text = await res.text();
   const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
   if(!jsonMatch) throw new Error("ÁÑ°Ê≥ïËß£Êûê Google Sheets JSON");
   const json = JSON.parse(jsonMatch[1]);
   const rows = json.table.rows;
   const projects = rows.slice(1).filter(r=>r.c && r.c[0]?.v).map(r=>({
     name: r.c[0]?.v || "",
     team: r.c[1]?.v || "",
     manager: r.c[2]?.v || "",
     secretary: r.c[3]?.v || "",
     possession: r.c[4]?.v || "",
     completion: r.c[5]?.v || "",
     deadlineText: r.c[6]?.v || ""
   }));
   // Êåâ Team ÂàÜÁµÑ
   const teams = {};
   projects.forEach(p=>{
     const teamKey = p.team.split(":")[0].trim();
     if(!teams[teamKey]) teams[teamKey] = [];
     teams[teamKey].push(p);
   });
   renderTeams(teams);
 } catch(err){
   console.error("JSON load error:", err);
 }
}
function renderTeams(teams){
 const container = document.getElementById("container");
 const now = new Date();
 const months = Array.from({length:12},(_,i)=>new Date(now.getFullYear(),now.getMonth()+i,1));
 const monthNames = months.map(m => m.toLocaleString('en', {month:'short'}) + "-" + m.getFullYear().toString().slice(-2));
 const tooltip = document.getElementById("tooltip");
 Object.keys(teams).forEach(teamKey=>{
   const h2 = document.createElement("h2");
   h2.textContent = teamKey;
   container.appendChild(h2);
   // Êåâ Project Manager ÂàÜÁµÑ
   const managerGroups = {};
   teams[teamKey].forEach(p=>{
     if(!managerGroups[p.manager]) managerGroups[p.manager]=[];
     managerGroups[p.manager].push(p);
   });
   Object.keys(managerGroups).forEach(manager=>{
     const h3 = document.createElement("h3");
     h3.textContent = manager;
     container.appendChild(h3);
     // Â∞çÊØèÂÄã PM Áπ™Ë£ΩÁîòÁâπÂúñ
     const ganttContainer = document.createElement("div");
     ganttContainer.style.position="relative";
     ganttContainer.style.height = managerGroups[manager].length*30 + "px"; // ÊØèÊ¢ùÊ£íË°åË∑ù 30px
     container.appendChild(ganttContainer);
     const pmDrawnSegments = []; // Â≠òÊîæÊâÄÊúâÂ∑≤Áï´ÁöÑÊ£íÊÆµ {start,end,top}
     managerGroups[manager].forEach((p,i)=>{
       const infoDiv = document.createElement("div");
       infoDiv.className = "project-info";
       infoDiv.innerHTML=`
<h4>${p.name}</h4>
<p><b>Project Secretary:</b> ${p.secretary}</p>
<p><b>Deadline:</b> ${p.deadlineText}</p>
<p class="countdown" id="cd-${teamKey}-${manager}-${i}"></p>
<p><b>Tentative Possession:</b> ${p.possession}</p>
<p><b>Tentative Completion:</b> ${p.completion}</p>
       `;
       container.appendChild(infoDiv);
       createCountdown(p.deadlineText,`cd-${teamKey}-${manager}-${i}`);
       createSegmentedGantt(p.possession,p.completion,ganttContainer,teamBaseColors[teamKey],overlapColor,pmDrawnSegments,tooltip,i);
     });
     // Êúà‰ªΩËª∏
     const monthAxis = document.createElement("div");
     monthAxis.className = "month-axis";
     monthAxis.style.marginTop = (managerGroups[manager].length*30+4) + "px";
     monthAxis.innerHTML = monthNames.map(m=>`<div>${m}</div>`).join("");
     container.appendChild(monthAxis);
   });
 });
}
function createCountdown(dltxt,id){
 const target=new Date(dltxt.replace(" ","T"));
 function tick(){
   const el=document.getElementById(id);
   const now=new Date();
   const diff=target-now;
   if(diff<=0){el.textContent="üéâ Completed!";return;}
   const d=Math.floor(diff/(1000*60*60*24));
   const h=Math.floor((diff/(1000*60*60))%24);
   const m=Math.floor((diff/(1000*60))%60);
   const s=Math.floor((diff/1000)%60);
   el.textContent=`${d} Days ${h} Hours ${m} Minutes ${s} Seconds`;
 }
 tick();
 setInterval(tick,1000);
}
// Âà§Êñ∑ÂÖ©ÂÄãÊôÇÈñìÁØÑÂúçÊòØÂê¶ÈáçÁñä
function isOverlap(start1,end1,start2,end2){ return start1<end2 && end1>start2; }
// Â∞áÂ∞àÊ°àÂàÜÊÆµÁπ™Ë£ΩÔºåÂè™ÊääÈáçÁñäÈÉ®ÂàÜËÆäËâ≤
function createSegmentedGantt(posTxt, compTxt, container, baseColor, overlapColor, drawnSegments, tooltip,index){
 if(!posTxt||!compTxt) return;
 const now = new Date();
 const months = Array.from({length:12},(_,i)=>new Date(now.getFullYear(),now.getMonth()+i,1));
 const possession = new Date(posTxt.replace(" ","T"));
 const completion = new Date(compTxt.replace(" ","T"));
 let startIndex=0,endIndex=11;
 for(let i=0;i<12;i++){
   if(months[i]<=possession) startIndex=i;
   if(months[i+1]>completion){endIndex=i; break;}
 }
 const totalMonths=12;
 const leftPercent = (startIndex/totalMonths)*100;
 const widthPercent = ((endIndex-startIndex+1)/totalMonths)*100;
 const topOffset = index*30; // ÊØèÊ¢ùÊ£íË°åË∑ù 30px
 // ÊâæÂá∫ÈáçÁñäÂçÄÊÆµ
 const segments = [];
 let segStart=startIndex;
 let segColor=baseColor;
 for(let i=startIndex;i<=endIndex;i++){
   let overlap=false;
   drawnSegments.forEach(seg=>{
     if(isOverlap(i,i,i,i)){ // Á≤æÁ¢∫Âà∞Êúà‰ªΩ
       overlap=true;
     }
   });
   if(overlap){
     if(segColor!==overlapColor){
       if(segStart<i){
         segments.push({start:segStart,end:i-1,color:segColor});
       }
       segStart=i;
       segColor=overlapColor;
     }
   } else {
     if(segColor!==baseColor){
       if(segStart<i){
         segments.push({start:segStart,end:i-1,color:segColor});
       }
       segStart=i;
       segColor=baseColor;
     }
   }
 }
 segments.push({start:segStart,end:endIndex,color:segColor});
 // Áπ™Ë£Ω segments
 segments.forEach(seg=>{
   const segLeft = (seg.start/totalMonths)*100;
   const segWidth = ((seg.end-seg.start+1)/totalMonths)*100;
   const bar=document.createElement("div");
   bar.className="gantt-segment";
   bar.style.left = segLeft+"%";
   bar.style.width = segWidth+"%";
   bar.style.top = topOffset+"px";
   bar.style.backgroundColor = seg.color;
   bar.addEventListener("mousemove", e=>{
     tooltip.style.display="block";
     tooltip.style.left = e.pageX+10+"px";
     tooltip.style.top = e.pageY+10+"px";
     tooltip.innerHTML = `Tentative Possession: ${posTxt}<br>Tentative Completion: ${compTxt}`;
   });
   bar.addEventListener("mouseleave",()=>{tooltip.style.display="none";});
   container.appendChild(bar);
 });
 drawnSegments.push({start:startIndex,end:endIndex,top:topOffset});
}
loadProjects();
</script>
</body>
</html>